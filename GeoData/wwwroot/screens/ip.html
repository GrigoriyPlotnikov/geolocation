<meta name="controlhead" content="Поиск по IP" />
<title>Экран поиска гео-информации</title>
<h1>Экран поиска гео-информации</h1>

<form onsubmit="
  event.preventDefault();
  let params = new URLSearchParams(window.location.search);
  params.set('ip', this['ip'].value);
  window.location.search = params;
  ">
  <label>IP: <input type="text" name="ip" placeholder="123.234.123.234"></label><input type="submit" value="Искать" style="margin-left:8px">
</form>

<div><label>Результаты поиска по <input type="text" id="backwards" data-bind="ip" disabled /> IP:</label> </div>

<div>
  <div repeat="locations">
    <div>Страна: <span name="country">{{item.country}}</span></div>
    <div>Регион: <span name="region">{{item.region}}</span></div>
    <div>Город: <span name="city">{{item.city}}</span></div>
    <div>Почтовый код: <span name="city">{{item.postal}}</span></div>
    <div>Организация: <span name="city">{{item.organization}}</span></div>
    <div>Широта: <span name="city">{{item.latitude}}</span></div>
    <div>Долгота: <span name="city">{{item.longitude}}</span></div>
  </div>
</div>
<div>
  <div repeat="errors"> <label>Ошибка: <span name="error">{{item}}</span></label></div>
</div>

<script>
  // @ts-check

  /** current case:
   * scripts form context,
   * context later data bound on lists and observables
   * complain: can i have more fancy code over search? something with async
   * complain: debug is pain
   * todo: load without refresh of other components
   */
  //debugger;

  /**
   * @typedef {Object} GeoDataLocation
   * @property {string} country
   * @property {string} region
   * @property {string} city
   * @property {string} postal
   * @property {string} organization
   * @property {number} latitude
   * @property {number} longitude
   * */

  const params = new URLSearchParams(window.location.search);
  this.ip = this.observable(params.get('ip'));
  /** @type {GeoDataLocation[]} */
  this.locations = [];
  /** @type {string[]} */
  this.errors = [];

  if (this.ip.value) {
    const state = this;
    this.promise = fetch(`./ip/location?ip=${state.ip.value}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`Сервер не смог обработать запрос. Код ответа: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        /** @type {GeoDataLocation} */
        const loc = data;
        if (!loc || !loc.city)
          throw new Error('Местоположение не найдено');
        state.locations.push(loc);
      })
      .catch(ex => {
        state.errors.push(ex.message);
      });
  }
</script>
